import 'dotenv/config';
import express from 'express';
import { Telegraf } from 'telegraf';

const { BOT_TOKEN, WEBAPP_URL, PORT = 3000 } = process.env;
if (!BOT_TOKEN) {
  console.error('âŒ BOT_TOKEN is missing');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// Ð›Ð¾Ð³Ð¸ Ð²ÑÐµÐ³Ð¾ Ð²Ñ…Ð¾Ð´ÑÑ‰ÐµÐ³Ð¾
bot.use((ctx, next) => {
  console.log('âž¡ï¸ Update:', ctx.updateType, ctx.update?.message?.text);
  return next();
});

// /start Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¾Ð¹ WebApp
bot.start((ctx) => {
  console.log('ðŸ’¬ /start from', ctx.from?.id, ctx.from?.username);
  return ctx.reply('Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ðŸ‘‡', {
    reply_markup: {
      keyboard: [[{ text: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÑˆÐºÐ°Ð»Ñƒ', web_app: { url: WEBAPP_URL } }]],
      resize_keyboard: true,
    },
  });
});

// ÐŸÑ€Ð¸Ñ‘Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· WebApp
bot.on('message', async (ctx) => {
  const data = ctx.message?.web_app_data?.data;
  if (!data) return;
  console.log('ðŸ“¦ web_app_data:', data);
  try {
    const payload = JSON.parse(data);
    if (payload.type === 'deal') {
      const amount = Number(payload.amount || 0);
      const total = Number(payload.monthly_sum || 0);
      await ctx.reply(
        `Ð—Ð°Ñ‡Ð»Ð¸: ${amount.toLocaleString('ru-RU')} âœ…\nÐ˜Ñ‚Ð¾Ð³Ð¾ Ð·Ð° Ð¼ÐµÑÑÑ†: ${total.toLocaleString('ru-RU')}`
      );
    }
  } catch (e) {
    console.error('âŒ parse web_app_data failed', e);
  }
});

const app = express();
app.get('/', (_, res) => res.send('HTTP OK: bot process is running'));
app.listen(PORT, () => console.log('ðŸŒ HTTP on', PORT));

// Ð¯Ð’ÐÐž Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð²ÐµÐ±Ñ…ÑƒÐº Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ long polling
(async () => {
  try {
    const me = await bot.telegram.getMe();
    console.log(`âœ… Bot token OK: @${me.username}`);
    await bot.telegram.deleteWebhook();
    console.log('ðŸ”§ Webhook deleted');
    await bot.launch({ dropPendingUpdates: true });
    console.log('ðŸš€ Long polling launched');
  } catch (e) {
    console.error('âŒ launch failed:', e);
  }
})();

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
